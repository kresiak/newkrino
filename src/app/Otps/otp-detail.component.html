<template #popContent>{{isRoot ? 'Click here to go back to last view' : 'Click here to get a detail view'}}</template>

<ngb-tabset *ngIf="otp" (tabChange)="beforeTabChange($event)" [activeId]="state.selectedTabId">
	<ngb-tab title="Info" id="tabInfo">
		<template ngbTabContent>
			<div class="card">
				<div class="card-block">
					<div class="row">
						<div class="col-sm-4 vcenter">otp:</div>
						<div class="col-sm-6 vcenter">
							<gg-editor [content]="otp.data.name" [showControls]="true" (editSaved)="nameUpdated($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4 vcenter">description:</div>
						<div class="col-sm-6 vcenter">
							<gg-editor [content]="otp.data.description" [showControls]="true" (editSaved)="descriptionUpdated($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4 vcenter">equipe:</div>
						<div class="col-sm-6 vcenter">
							<gg-editor-autocomplete [selectableData]="equipeListObservable" [selectedId]="otp.data.equipeId" (idChanged)="equipeChanged($event)" ></gg-editor-autocomplete>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4 vcenter">allowed products:</div>
						<div class="col-sm-6 vcenter">
							<gg-selector [selectableData]="selectableCategoriesObservable" [selectedIds]="selectedCategoryIdsObservable" (selectionChanged)="categorySelectionChanged($event)"
								(selectionOptionAdded)="categoryHasBeenAdded($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-selector>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4 vcenter">is limited to owner equipe:</div>
						<div class="col-sm-6 vcenter">
							<gg-editor-boolean [content]="otp.data.isLimitedToOwner" (editSaved)="limitedToOwnerUpdated($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor-boolean>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4 vcenter">is blocked:</div>
						<div class="col-sm-6 vcenter">
							<gg-editor-boolean [content]="otp.data.isBlocked" (editSaved)="blockedUpdated($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor-boolean>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4 vcenter">is closed:</div>
						<div class="col-sm-6 vcenter">
							<gg-editor-boolean [content]="otp.data.isClosed" (editSaved)="closedUpdated($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor-boolean>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4 vcenter">is deleted:</div>
						<div class="col-sm-6 vcenter">
							<gg-editor-boolean [content]="otp.data.isDeleted" (editSaved)="deletedUpdated($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor-boolean>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4 vcenter">priority:</div>
						<div class="col-sm-6 vcenter">
							<gg-editor-number [content]="otp.data.priority" (editSaved)="priorityUpdated($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor-number>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-2">
							<img *ngIf="!otp.annotation.dashletId" src="../../images/pin.png" (click)="setDashlet()" />
							<img *ngIf="otp.annotation.dashletId" src="../../images/unpin.png" (click)="removeDashlet(otp.annotation.dashletId)" />
						</div>
					</div>

					<div class="row" *ngIf="!authService.isProduction()">
						<div class="col-sm-4">_id:</div>
						<div class="col-sm-6">{{otp.data._id}}</div>
					</div>

				</div>
			</div>
		</template>
	</ngb-tab>
	<ngb-tab title="Budget" id="tabBudget">
		<template ngbTabContent>
			<div class="card">
				<div class="card-block">
					<div class="row">
						<div class="row">
							<div class="col-sm-3 vcenter">total budget:</div>
							<div class="col-sm-7 vcenter">
								<gg-editor [content]="otp.data.budget" [showControls]="true" [isMonetary]="true" (editSaved)="budgetUpdated($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-3 vcenter">from:</div>
							<div class="col-sm-7 vcenter">
								<gg-editor-date [content]="otp.data.datStart" (editSaved)="dateUpdatedStart($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor-date>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-3 vcenter">to:</div>
							<div class="col-sm-7 vcenter">
								<gg-editor-date [content]="otp.data.datEnd" (editSaved)="dateUpdated($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor-date>
							</div>
						</div>
						<div class="row">
							<label for="isAnnual" class="col-sm-3 col-form-label col-xl-3 vcenter">is annual:</label>
							<div class="col-md-1 vcenter">
								<gg-checkbox [checked]="isAnnualSelected(isAnnual)" (checkedChange)="isAnnualChecked($event)"></gg-checkbox>
							</div>
						</div>
						<div class="form-group row" *ngIf="otp.data.isAnnual">
							<form [formGroup]="annualForm" (ngSubmit)="save(annualForm.value, annualForm.valid)" >
								<div class="form-group row">
									<label for="budgetAnnual" class="col-sm-3 col-form-label col-xl-3">budget:</label>
									<div class="col-sm-7">
										<input type="number" min="0" step="any" class="form-control" formControlName="budgetAnnual" id="budgetAnnual" placeholder="Budget annual">
									</div>
								</div>
								<div class="form-group row">
									<div class="col-sm-3 vcenter">from:</div>
									<div class="col-sm-7 vcenter">
										<gg-editor-date [content]="otp.data.datStartAnnual" (editSaved)="updatedDateStartAnnual($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor-date>
									</div>
								</div>
								<div class="form-group row">
									<div class="col-sm-3 vcenter">to:</div>
									<div class="col-sm-7 vcenter">
										<gg-editor-date [content]="otp.data.datEndAnnual" (editSaved)="updatedDateEndAnnual($event)" [readOnly]="!authorizationStatusInfo || !authorizationStatusInfo.isAdministrator()"></gg-editor-date>
									</div>
								</div>
								<div class="form-group row">
									<div class="col-sm-3 col-md-2 col-lg-2">
										<button class="btn btn-success" type="submit" [disabled]="!annualForm.valid">Submit</button>
									</div>
									<div class="col-sm-3 col-md-2 col-lg-2">
										<button class="btn btn-info"  [disabled]="annualForm.pristine" (click)="reset()">Reset</button>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</template>
	</ngb-tab>

	
	<ngb-tab title="Spending" id="tabSpending" *ngIf="otpBudget">
		<template ngbTabContent>
			<div class="card">
				<div class="card-block">
					<div class="row">
						<div class="col-sm-4">total budget:</div>
						<div class="col-sm-6">+ {{otpBudget.annotation.budget | currency:'EUR':true:'1.2-2'}}</div>
					</div>
					<div class="row">
						<div class="col-sm-4">amount spent or blocked:</div>
						<div class="col-sm-6">- {{otpBudget.annotation.amountSpent | currency:'EUR':true:'1.2-2'}}</div>
					</div>
					<div class="row">
						<div class="col-sm-4"></div>
						<div class="col-sm-6">================</div>
					</div>
					<div class="row">
						<div class="col-sm-4">amount available:</div>
						<div class="col-sm-6">= {{otpBudget.annotation.amountAvailable | currency:'EUR':true:'1.2-2'}}</div>
					</div>
					<div class="row">
						<div class="col-sm-4"></div>
						<div class="col-sm-6"></div>
					</div>
					<div class="row">
						<div class="col-sm-4">amount blocked in purchase orders:</div>
						<div class="col-sm-6">{{otpBudget.annotation.amountSpentNotYetInSap | currency:'EUR':true:'1.2-2'}}</div>
					</div>
					<div class="row">
						<div class="col-sm-4">amount blocked still engaged:</div>
						<div class="col-sm-6">{{otpBudget.annotation.amountEngaged | currency:'EUR':true:'1.2-2'}}</div>
					</div>
					<div class="row">
						<div class="col-sm-4">amount spent in invoices:</div>
						<div class="col-sm-6">{{otpBudget.annotation.amountBilled | currency:'EUR':true:'1.2-2'}}</div>
					</div>
				</div>
			</div>
		</template>
	</ngb-tab>
	<ngb-tab title="Charts" id="tabCharts">
		<template ngbTabContent>
			<div class="card">
				<div class="card-block">
					<div class="row">
						<div class="col-sm-6">
							<div class='akbox'>
								<div class='akcontent'>
									<x-chartist [data]="pieSpentChart.data" [type]="pieSpentChart.type"></x-chartist>
								</div>
							</div>

						</div>"
					</div>

				</div>
			</div>
		</template>
	</ngb-tab>
	<ngb-tab title="Comments" id="tabComments">
		<template ngbTabContent>
			<gg-comments [comments]="otp.data.comments" (commentsUpdated)="commentsUpdated($event)"></gg-comments>
		</template>
	</ngb-tab>
	<ngb-tab title="Orders" *ngIf="anyOrder" id="tabOrders">
		<template ngbTabContent>
			<gg-order-list [ordersObservable]="ordersObservable" [state]="state.Orders" [path]="path+'|O:Orders'" (stateChanged)="childOrdersStateChanged($event)"></gg-order-list>
		</template>
	</ngb-tab>
	<ngb-tab title="SAP" *ngIf="sapIdList" id="tabSaps">
		<template ngbTabContent>
			<div class="card">
				<div class="card-block">
					<ngb-tabset>
						<ngb-tab title="All items" id="tabSapsAll">
							<template ngbTabContent>
								<gg-sap-by-sapids-list [sapIdList]="sapIdList" [otp]="otp" [state]="state.Saps" [path]="path+'|O:Saps'"  (stateChanged)="childSapsStateChanged($event)"></gg-sap-by-sapids-list>
							</template>
						</ngb-tab>
						<ngb-tab title="By date" id="tabSapsByDate">
							<template ngbTabContent>
								<gg-sap-by-date [otp]="otp.data.name"></gg-sap-by-date>
							</template>
						</ngb-tab>						
					</ngb-tabset>
				</div>
			</div>
		</template>
	</ngb-tab>


	<ngb-tab id="tabMax">
		<template ngbTabTitle><img src="../../images/maximize.png" [ngbPopover]="popContent" triggers="mouseenter:mouseleave" /></template>
		<template ngbTabContent></template>
	</ngb-tab>
	<ngb-tab id="gotoTop" *ngIf="!isRoot && path!=='dashboard'">
		<template ngbTabTitle><img src="../../images/gototop.png" ngbPopover="Goto top of the page" triggers="mouseenter:mouseleave" /></template>
		<template ngbTabContent></template>
	</ngb-tab>
	
</ngb-tabset>
